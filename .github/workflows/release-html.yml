name: Release HTML with Checksums

on:
  release:
    types: [published]

jobs:
  checksums:
    name: Generate SHA256 Checksums
    runs-on: ubuntu-latest
    permissions:
      contents: write
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v4

    - name: Build WHITEPAPER.pdf
      uses: xu-cheng/latex-action@v3
      with:
        root_file: WHITEPAPER.tex
        args: -pdf -interaction=nonstopmode -halt-on-error
    
    - name: Generate SHA256 checksums for HTML
      run: |
        set -euo pipefail
        VERSION="${GITHUB_REF_NAME}"
        GENERATED_UTC="$(date -u +"%Y-%m-%d %H:%M:%S UTC")"

        FILES=(
          "reference-implementation/schiavinato_sharing.html"
          "WHITEPAPER.pdf"
          "WHITEPAPER.tex"
          "RFC.md"
          "TEST_VECTORS.md"
          "LICENSE"
          "LICENSE-WHITEPAPER.md"
        )

        echo "# SHA256 Checksums for Schiavinato Sharing" > CHECKSUMS.txt
        echo "" >> CHECKSUMS.txt
        echo "Version: ${VERSION}" >> CHECKSUMS.txt
        echo "Generated: ${GENERATED_UTC}" >> CHECKSUMS.txt
        echo "" >> CHECKSUMS.txt
        sha256sum "${FILES[@]}" >> CHECKSUMS.txt
        echo "" >> CHECKSUMS.txt
        echo "## Verification" >> CHECKSUMS.txt
        echo "" >> CHECKSUMS.txt
        echo "sha256sum -c CHECKSUMS.txt" >> CHECKSUMS.txt

        python - <<'PY'
        import hashlib, json, os
        from datetime import datetime, timezone

        version = os.environ.get("GITHUB_REF_NAME", "")
        generated = datetime.now(timezone.utc).strftime("%Y-%m-%dT%H:%M:%SZ")
        files = [
          "reference-implementation/schiavinato_sharing.html",
          "WHITEPAPER.pdf",
          "WHITEPAPER.tex",
          "RFC.md",
          "TEST_VECTORS.md",
          "LICENSE",
          "LICENSE-WHITEPAPER.md",
        ]

        def sha256(path: str) -> str:
            h = hashlib.sha256()
            with open(path, "rb") as f:
                for chunk in iter(lambda: f.read(1024 * 1024), b""):
                    h.update(chunk)
            return h.hexdigest()

        payload = {
          "version": version,
          "generated": generated,
          "checksums": {p: sha256(p) for p in files},
        }

        with open("CHECKSUMS.json", "w", encoding="utf-8") as f:
            json.dump(payload, f, indent=2, sort_keys=True)
            f.write("\n")
        PY
    
    - name: Import GPG key
      run: |
        echo "${{ secrets.GPG_PRIVATE_KEY }}" | gpg --batch --import
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --quick-set-expire $(gpg --list-secret-keys --with-colons | grep fpr | head -1 | cut -d: -f10) 0
    
    - name: Sign HTML file with GPG
      run: |
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --armor --detach-sign reference-implementation/schiavinato_sharing.html
        
        # Verify signature
        gpg --verify reference-implementation/schiavinato_sharing.html.asc reference-implementation/schiavinato_sharing.html
        
        echo "=== HTML GPG Signature Created ==="
        ls -lh reference-implementation/schiavinato_sharing.html.asc
    
    - name: Sign checksums with GPG
      run: |
        # Sign CHECKSUMS.txt
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --armor --detach-sign CHECKSUMS.txt
        
        # Sign CHECKSUMS.json
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --armor --detach-sign CHECKSUMS.json
        
        # Verify signatures
        gpg --verify CHECKSUMS.txt.asc CHECKSUMS.txt
        gpg --verify CHECKSUMS.json.asc CHECKSUMS.json
        
        echo "=== Checksum GPG Signatures Created ==="
        ls -lh CHECKSUMS.*.asc
    
    - name: Create release tarball
      run: |
        tar -czf schiavinato-sharing-spec-${GITHUB_REF_NAME}.tar.gz \
          reference-implementation/schiavinato_sharing.html \
          WHITEPAPER.pdf \
          WHITEPAPER.tex \
          RFC.md \
          TEST_VECTORS.md \
          LICENSE \
          LICENSE-WHITEPAPER.md \
          CHECKSUMS.txt \
          CHECKSUMS.json
        
        sha256sum schiavinato-sharing-spec-${GITHUB_REF_NAME}.tar.gz > schiavinato-sharing-spec-${GITHUB_REF_NAME}.tar.gz.sha256
    
    - name: Sign tarball with GPG
      run: |
        # Sign the tarball
        echo "${{ secrets.GPG_PASSPHRASE }}" | gpg --batch --yes --passphrase-fd 0 --pinentry-mode loopback --armor --detach-sign schiavinato-sharing-spec-${GITHUB_REF_NAME}.tar.gz
        
        # Verify signature
        gpg --verify schiavinato-sharing-spec-${GITHUB_REF_NAME}.tar.gz.asc schiavinato-sharing-spec-${GITHUB_REF_NAME}.tar.gz
        
        echo "=== Tarball GPG Signature Created ==="
        ls -lh schiavinato-sharing-spec-*.tar.gz.asc
    
    - name: Upload release artifacts with signatures
      uses: softprops/action-gh-release@v1
      with:
        files: |
          reference-implementation/schiavinato_sharing.html.asc
          WHITEPAPER.pdf
          CHECKSUMS.txt
          CHECKSUMS.txt.asc
          CHECKSUMS.json
          CHECKSUMS.json.asc
          schiavinato-sharing-spec-*.tar.gz
          schiavinato-sharing-spec-*.tar.gz.sha256
          schiavinato-sharing-spec-*.tar.gz.asc
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

